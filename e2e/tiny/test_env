#!/usr/bin/env bash
set -euo pipefail
# shellcheck source-path=SCRIPTDIR
source "$(dirname "${BASH_SOURCE[0]}")"/../assert.sh

cat <<'EOF' >.mise.toml
[tools]
tiny = "3.1.0"

[env]
mise.file = ['.test-env']
EOF

echo FOO_FROM_FILE=foo_from_file >.test-env
echo TEST_ENV2=foo >.test-env2

mise i tiny
(
  eval "$(mise env -s bash)"
  assert_contains "rtx-tiny" "v3.1.0"
)

mise i tiny@2.0.0
(
  eval "$(mise env -s bash tiny@2.0.0)"
  assert_contains "rtx-tiny" "v2.0.0"
)

assert "mise x -- env | grep FOO_FROM_FILE" "FOO_FROM_FILE=foo_from_file"
assert "MISE_ENV_FILE=.test-env mise x -- env | grep TEST_ENV2" "TEST_ENV2=foo"

cat <<EOF >.mise.toml
[env]
ENV_TMPL_EXEC = "{{ exec(command='echo foo') }}"
EOF

assert "mise env -s zsh | grep ENV_TMPL_EXEC" "export ENV_TMPL_EXEC=foo"
