#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
FILES="$(find "$SCRIPT_DIR" -name 'test_*' -type f -printf '%P\n' | sort)"
test_count=0
test_successes=0
test_failures=0

if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
  {
    echo "| Test | Duration | Result |"
    echo "| ---- | -------- | ------ |"
  } >>"$GITHUB_STEP_SUMMARY"
fi
for f in $FILES; do
  # split tests into two tranches to reduce test time
  if [ -n "${TEST_TRANCHE_COUNT:-}" ]; then
    char_count=${#f}
    if [[ $((char_count % "$TEST_TRANCHE_COUNT")) -ne "$TEST_TRANCHE" ]]; then
      continue
    fi
  fi
  if "$ROOT/e2e/run_test" "$f"; then
    test_successes=$((test_successes + 1))
  else
    test_failures=$((test_failures + 1))
  fi
  echo
  test_count=$((test_count + 1))
done

echo "e2e: $test_count tests passed, $test_successes succeeded, $test_failures failed"

[[ $test_failures = 0 ]]
