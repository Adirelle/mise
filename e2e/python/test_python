# shellcheck shell=bash

export MISE_PYTHON_DEFAULT_PACKAGES_FILE="$ROOT/e2e/.default-python-packages"

cat >.mise.toml <<EOF
[env._.python]
venv = {path = "{{env.MISE_DATA_DIR}}/venv", create=true}
[tools]
python = "{{exec(command='echo 3.12.0')}}"
EOF

mise i
#mise x -- python -m venv "$MISE_DATA_DIR/venv"
assert_contains "mise x python@3.12.0 -- python --version" "Python 3.12.0"
assert_contains "mise env -s bash | grep VIRTUAL_ENV" "$MISE_DATA_DIR/venv"
assert "mise x -- which python" "$MISE_DATA_DIR/venv/bin/python"

# verify nested virtualenv is used
mkdir -p subdir
cat >subdir/.mise.toml <<EOF
[env._.python]
venv = {path = "{{env.MISE_DATA_DIR}}/subvenv", create=true}
[tools]
python = "{{exec(command='echo 3.12.0')}}"
EOF

cd subdir || exit
mise i
assert_contains "mise x python@3.12.0 -- python --version" "Python 3.12.0"
assert_contains "mise env -s bash | grep VIRTUAL_ENV" "$MISE_DATA_DIR/subvenv"
assert "mise x -- which python" "$MISE_DATA_DIR/subvenv/bin/python"

rm -rf subdir

skip_slow_test

export MISE_ALL_COMPILE=1
mise i python -f
assert_contains "mise x python@3.12.0 -- python --version" "Python 3.12"
